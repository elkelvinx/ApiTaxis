name: Build and Publish ASP.NET Web App - ApiTaxis

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ”¹ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”¹ Instalar MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: ğŸ”¹ Instalar NuGet
        uses: NuGet/setup-nuget@v1.2.0

      - name: ğŸ”¹ Restaurar paquetes NuGet
        run: nuget restore "TaxisTeodoro.sln"

      - name: ğŸ”¹ Compilar soluciÃ³n en Release
        run: msbuild "TaxisTeodoro.sln" /p:Configuration=Release /m

      - name: ğŸ”¹ Crear carpeta de publicaciÃ³n
        shell: pwsh
        run: |
          $publishDir = "$Env:GITHUB_WORKSPACE\publish_output"
          if (-not (Test-Path $publishDir)) {
            New-Item -ItemType Directory -Force -Path $publishDir | Out-Null
          }
          Write-Host "ğŸ“ Carpeta de publicaciÃ³n creada en: $publishDir"

      - name: ğŸ”¹ Publicar proyecto Web (FileSystem)
        shell: pwsh
        run: |
          $projectPath = "inventario5sem\TaxisTeodoro.csproj"
          $publishDir = "$Env:GITHUB_WORKSPACE\publish_output"

          if (-not (Test-Path $projectPath)) {
            Write-Error "âŒ No se encontrÃ³ el proyecto en la ruta: $projectPath"
            exit 1
          }

          Write-Host "ğŸš€ Publicando proyecto $projectPath en $publishDir ..."
          msbuild $projectPath /p:Configuration=Release /p:WebPublishMethod=FileSystem /p:DeleteExistingFiles=true /p:publishUrl=$publishDir

          if (-not (Test-Path $publishDir)) {
            Write-Error "âŒ No se generÃ³ la carpeta de publicaciÃ³n."
            exit 1
          }

      - name: ğŸ”¹ Verificar archivos publicados
        shell: pwsh
        run: |
          $publishDir = "$Env:GITHUB_WORKSPACE\publish_output"
          if (Test-Path $publishDir) {
            Write-Host "âœ… Archivos publicados correctamente en $publishDir"
            Get-ChildItem $publishDir -Recurse | Select-Object FullName
          } else {
            Write-Error "âŒ La carpeta publish_output no existe despuÃ©s del Publish."
            exit 1
          }

      - name: ğŸ”¹ Crear ZIP del resultado
        shell: pwsh
        run: |
          $zip = "$Env:GITHUB_WORKSPACE\web_publish.zip"
          $publishDir = "$Env:GITHUB_WORKSPACE\publish_output"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$publishDir\*" -DestinationPath $zip
          Write-Host "ğŸ“¦ Archivo ZIP creado en: $zip"

      - name: ğŸ”¹ Subir artefacto compilado
        uses: actions/upload-artifact@v4
        with:
          name: WebPublishPackage
          path: ${{ github.workspace }}\web_publish.zip
